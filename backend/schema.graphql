type Page @auth(
  query: { or: [
    # NOTE: can see public Pages (no creator)
    { rule: "query { queryPage(filter: { not: { has: creator } }) { id } }"}
    # NOTE: can see my created Pages (creator=me)
    { rule: "query ($username: String!) { queryPage { creator(filter: { email: { eq: $username } }) { email } } }" }
  ]}
  update: { or: [
    # NOTE: can update public Pages
    { rule: "query { queryPage(filter: { not: { has: creator } }) { id } }"}
    # NOTE: can update my created Pages
    { rule: "query ($username: String!) { queryPage { creator(filter: { email: { eq: $username } }) { email } } }" }
  ]}
  delete: { or: [
    # NOTE: only users with isAdmin can delete public pages
    { rule: "{ $isAdmin: { eq:\"true\" } }"}
    # NOTE: can delete my created Pages
    { rule: "query ($username: String!) { queryPage { creator(filter: { email: { eq: $username } }) { email } } }" }
  ]}
) {
  id: ID!
  blocks: [Block]
  creator: User
  createdAt: DateTime!
  updatedAt: DateTime
}

type Block @auth(
  add: { or: [
    # NOTE: can add blocks to public pages
    { rule: "query { queryBlock { page(filter: { not: { has: creator } }) { id } } }" }
    # NOTE: can add blocks to my created pages
    { rule: "query ($username: String!) { queryBlock { page { creator(filter: { email: { eq: $username } }) { email } } } }" }
  ]}
  query: { or: [
    # NOTE: can query blocks for public pages
    { rule: "query { queryBlock { page(filter: { not: { has: creator } }) { id } } }" }
    # NOTE: can query blocks for my created pages
    { rule: "query ($username: String!) { queryBlock { page { creator(filter: { email: { eq: $username } }) { email } } } }" }
  ]}
  update: { or: [
    # NOTE: can update blocks on public pages
    { rule: "query { queryBlock { page(filter: { not: { has: creator } }) { id } } }" }
    # NOTE: can update blocks on my created pages
    { rule: "query ($username: String!) { queryBlock { page { creator(filter: { email: { eq: $username } }) { email } } } }" }
  ]}
  delete: { or: [
    # NOTE: can delete blocks on public pages
    { rule: "query { queryBlock { page(filter: { not: { has: creator } }) { id } } }" }
    # NOTE: can delete blocks on my created pages
    { rule: "query ($username: String!) { queryBlock { page { creator(filter: { email: { eq: $username } }) { email } } } }" }
  ]}
) {
  id: ID!
  type: String!
  html: String
  imageUrl: String
  page: Page! @hasInverse(field: blocks)
}

type User @auth(
  # NOTE: can only see own user
  query: { rule: "query ($username: String!) { queryUser(filter: { email: { eq: $username } }) { email } }" }
  # NOTE: can only update own user
  update: { rule: "query ($username: String!) { queryUser(filter: { email: { eq: $username } }) { email } }" }
  # NOTE: only user with isAdmin can delete user
  delete: { rule: "{ $isAdmin: { eq:\"true\" } }"}
) {
  email: String! @id
  name: String!
  pages: [Page] @hasInverse(field: creator)
  createdAt: DateTime!
  updatedAt: DateTime
}

# Dgraph.Authorization {"Header":"auth","Namespace":"https://dgraph.io/claims/graphqlkanban","Algo":"RS256","Audience":["eaNlZ3Hi019Ty8kfJ1cZ8iL4abmpZP24","VerificationKey":"-----BEGIN CERTIFICATE-----\nMIIDDTCCAfWgAwIBAgIJLQRlaTIoZyKuMA0GCSqGSIb3DQEBCwUAMCQxIjAgBgNV\nBAMTGWRldi05M2tlYmZqcy51cy5hdXRoMC5jb20wHhcNMjAxMTI3MDEzMzI2WhcN\nMzQwODA2MDEzMzI2WjAkMSIwIAYDVQQDExlkZXYtOTNrZWJmanMudXMuYXV0aDAu\nY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1On2d0G5ew0QVUrZ\nR9mGyIgS0cw+IpELf+BuyoKAO+8cRjmQiidN7C8K7lF8cvbdt7wpPXAx07VlxLb9\nGOACcwWjvf0gzcR9doCT1pJ+OkuqE8OKFBKrTTTm9uV/0dQzWbxYRtlFN2Fpopbj\nQCL3jK2muDElc2ZUyZ/y3A/2YXhHbAsMmRh3ZTea1SYW2PdJscSyARIpKs5655vu\nNK+X1ILZmzF6r0JBW8UidUnsCKvUXu6q++Ci6t+t2tMth0Yy1LR3ejqCis5k/K1n\n9UIbtmxwamBh46ZXEkeqH63DPeANBXtWeHZx07/6eYsyTBIKGId07Odt/TrLidNW\nBedAmQIDAQABo0IwQDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBT/KocLZscp\nGIRtJ+S9UMcwKdQ2tzAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADggEB\nAHjXFKbHrYJZq2wlpAEBCHc1SmHlDdFf4FcjrjHcyTLnhIufUedpX0wgwmkU8IYF\nit7FklKvbuqZp1xGCzSOPeXzlrzN0+/Dls4VoRuQBJ898wjRioy5xlrbv5MgBbcQ\ns1FQn4NmPtppDr38QbS/gwKgdMNqYHE69zfokzB43R7NqEXzoJXmXdIeiadc02Wv\nI1PT4zLELJh1s+5ouGWOrcjGr9qr8WvV0qVBs+NaIOauf6U1bw7RFWsjk1E0QrMW\ntzSAOmt/e3l45QBpImyTVaeW4bDlEvn3tGwD/ZcTjzGfLPlELpAjD+Wu4v1d1p4a\nWXA8gqQe+RvhMd6FTizbX2A=\n-----END CERTIFICATE-----"]}